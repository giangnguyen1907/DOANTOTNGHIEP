<?php
/**
 * PsAppTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsAppTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsAppTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsApp' );
	}

	/**
	 * setSQLPsApp($ps_app_root - Boolean) Load ung dung
	 *
	 * @author Nguyen Chien Thang
	 *        
	 * @param $id -
	 *        	int get all not in $id
	 * @param $ps_app_root -
	 *        	boolean : True: get root; False: get not root
	 * @param $addSQL -
	 *        	string SQL
	 * @return string sql
	 */
	public function setSQLPsApp($id = null, $ps_app_root = true) {

		$q = $this->createQuery ( 'app' )
			->select ( 'app.id, app.title AS name, ps_app_root' );

		if ($ps_app_root === true)
			$q->addWhere ( 'app.ps_app_root IS NULL' );
		elseif ($ps_app_root === false)
			$q->addWhere ( 'app.ps_app_root IS NOT NULL' );

		if ($id > 0)
			$q->addWhere ( 'app.id <> ?', ( int ) $id );

		// $q->addGroupBy('app.ps_app_root, app_code');
		$q->addOrderBy ( 'app.app_code' );
		// $q->addOrderBy('app.id');

		return $q;
	}

	/**
	 * FUNCTION: doSelectQuery(Doctrine_Query $query)
	 *
	 * @param
	 *        	Doctrine SQL
	 * @return string SQL
	 */
	public function doSelectQuery(Doctrine_Query $query) {

		$alias = $query->getRootAlias ();
		/*
		 * $query->addSelect(
		 * $alias.'.id,'.
		 * $alias.'.title, '.
		 * $alias.'.app_code, '.
		 * $alias.'.iorder,'.
		 * $alias.'.is_activated, '.
		 * $alias.'.ps_app_root,'.
		 * $alias.'.user_updated_id,'.
		 * $alias.'.updated_at,' .
		 * 'CONCAT(u.first_name," ",u.last_name) AS updated_by,' .
		 * 'ap_r.title AS ps_app_root_title')
		 * ->leftJoin($alias . '.UserUpdated u')
		 * ->leftJoin($alias . '.PsApp ap_r')
		 * ->addGroupBy($alias.'.ps_app_root, app_code')
		 * ->addOrderBy($alias.'.app_code');
		 */

		$query->addSelect ( $alias . '.*,' . 'CONCAT(u.first_name," ",u.last_name) AS updated_by,' . 'ap_r.title AS ps_app_root_title' )
			->leftJoin ( $alias . '.UserUpdated u' )
			->leftJoin ( $alias . '.PsApp ap_r' )
			->orderBy($alias . '.app_code' );
		//->addGroupBy($alias.'.ps_app_root, app_code')
		

		return $query;
	}

	// Lay gia tri Max cua iorder, return: int - max order
	public function getMaxIorder() {

		return $this->createQuery ()
			->select ( 'MAX(iorder) AS max_order' )
			->fetchOne ()
			->getMaxOrder ();
	}

	/**
	 * getGroupPsApps() -- Lay toan bo ung dung phan thanh nhom boi ps_app_root
	 *
	 * @author Nguyen Chien Thang
	 * @param
	 *        	null
	 * @return list option for tag SELECT of HTML
	 */
	public function getGroupPsApps() {

		$list = $this->setSQLPsApp ( null, null )
			->execute ();
		$chois = array ();

		foreach ( $list as $value ) {
			if (! $value->getPsAppRoot ()) {
				foreach ( $list as $key2 => $value2 ) {
					if ($value2->getPsAppRoot () > 0 && ($value->getId () == $value2->getPsAppRoot ())) {
						$chois [$value->getTitle ()] [$value2->getId ()] = $value2;
					}
				}
			}
		}

		return $chois;
	}
}