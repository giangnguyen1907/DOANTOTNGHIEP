<?php

/**
 * PsMemberAbsentsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsMemberAbsentsTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsMemberAbsentsTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsMemberAbsents' );
	}

	public function doSelectQuery(Doctrine_Query $query) {

		$a = $query->getRootAlias ();

		$query->select ( $a . '.id as id, ' . $a . '.member_id as member_id, ' . $a . '.absent_at as absent_at, ' . $a . '.absent_type as absent_type, ' . $a . '.description as description, ' . 'mb.id as mb_id,' . 'mb.member_code as member_code,' . 'CONCAT(mb.first_name, " ", mb.last_name) as teacher_name,' );
		$query->addSelect ( 'CONCAT(u.first_name, " ", u.last_name) as updated_by,' );

		$query->leftJoin ( $a . '.PsMember mb' );

		$query->innerJoin ( $a . '.UserUpdated u' );

		$query->orderBy ( $a . '.id desc' );

		return $query;
	}

	/**
	 * Lay danh sach ngay nghi cua nhan su
	 *
	 * @author Phung Van Thanh
	 *        
	 * @return $Obj
	 *
	 */
	public function getMemberAbsentInMonth($ps_customer_id, $ps_workplace_id, $department_id, $year_month) {

		$date_at = '01-' . $year_month;

		// echo $date_at; die();
		$query = $this->createQuery ( 'mba' );

		$query->select ( 'mba.id AS mba_id, ' . 'mba.absent_type AS absent_type, ' . 'mba.member_id AS member_id, ' . 'mba.absent_at AS absent_at' );

		$query->addSelect ( 'CONCAT(mb.first_name, " ", mb.last_name) AS member_name' );

		$query->innerJoin ( 'mba.PsMember mb' );

		$query->innerJoin ( 'mb.PsCustomer cus' );

		$query->innerJoin ( 'cus.PsDepartment dp' );

		$query->leftJoin ( 'mb.PsMemberDepartments dpm' );

		if ($department_id > 0)
			$query->addWhere ( 'dpm.ps_department_id = ?', $department_id );
		elseif ($ps_workplace_id)
			$query->addWhere ( 'dp.ps_workplace_id = ?', $ps_workplace_id );

		$query->andWhere ( ' DATE_FORMAT(dpm.start_at,"%Y%m%d") <= ?', date ( 'Ymd', strtotime ( $date_at ) ) );

		$query->andWhere ( 'dpm.stop_at IS NULL OR DATE_FORMAT(dpm.stop_at,"%Y%m%d") >= ?', date ( 'Ymd', strtotime ( $date_at ) ) );

		$query->andWhere ( 'DATE_FORMAT(mba.absent_at,"%Y%m") = ?', date ( 'Ym', strtotime ( $date_at ) ) );

		$query->addWhere ( 'mb.is_status = ?', 'W' );

		return $query->execute ();
	}
}