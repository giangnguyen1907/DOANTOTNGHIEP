<?php

/**
 * StudentServiceDiaryTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class StudentServiceDiaryTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object StudentServiceDiaryTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'StudentServiceDiary' );
	}

	public function doSelectQuery(Doctrine_Query $q) {

		$q = Doctrine_Query::create ()->from ( 'Student s' );
		$q->select ( 's.id AS student_id, ' . 's.image AS image, ' . 's.student_code AS student_code, ' . 's.last_name AS last_name, ' . 's.birthday AS birthday, ' . 'cus.school_code AS school_code,' . 'ssd.service_id as service_id,' . 'sc.myclass_id as class_id,' . 'sv.title as service_title,' . 'ssd.tracked_at as tracked_at,' . 'ssd.user_updated_id AS user_updated_id, ' . 's.ps_customer_id as ps_customer_id,' . 'ssd.updated_at AS updated_at' );

		$q->addSelect ( 'CONCAT(u.first_name, " ", u.last_name) AS updated_by' );
		$q->addSelect ( 'CONCAT(s.first_name, " ", s.last_name) AS student_name' );
		$q->leftJoin ( 's.StudentServiceDiary as ssd' );
		$q->innerJoin ( 's.PsCustomer cus' );
		$q->leftJoin ( 'ssd.UserUpdated u' );
		$q->leftJoin ( 'ssd.Service sv' );
		$q->leftJoin ( 's.StudentClass sc' );
		$q->orderBy ( 's.last_name' );

		if (! myUser::credentialPsCustomers () && myUser::getPscustomerID () > 0) {
			$q->where ( 's.ps_customer_id = ?', myUser::getPscustomerID () );
		}

		return $q;
	}

	/* ---------------------------------------------- */
	// Tim kiem StudentServiceDiary boi hoc sinh va ngay di hoc
	public function findByStudentTrackedAt($student_id, $tracked_at, $service_id = '') {

		$q = $this->createQuery ( 'c' )
			->select ( 'c.id' )
			->addWhere ( "c.student_id = ? ", $student_id )
			->addWhere ( "DATE_FORMAT(c.tracked_at, '%Y%m%d')=?", date ( 'Ymd', strtotime ( $tracked_at ) ) );

		if ($service_id > 0)
			$q->addWhere ( "c.service_id = ? ", $service_id );

		return $q->execute ();
	}

	/* ----------------Xoa dich vu diem danh cua 1 hoc sinh trong thang--------------------- */
	public function findByStudentServiceTrackedAt($student_id, $tracked_at, $service_id) {

		$q = $this->createQuery ( 'c' )
			->select ( 'c.id' )
			->addWhere ( "c.student_id = ? ", $student_id )
			->addWhere ( "DATE_FORMAT(c.tracked_at, '%Y%m')=?", date ( 'Ym', strtotime ( $tracked_at ) ) );

		$q->addWhere ( "c.service_id = ? ", $service_id );

		return $q->execute ();
	}

	/**
	 * Lay so luong hoc sinh da dung dich vu
	 *
	 * @author thangnc
	 *        
	 * @param
	 *        	$service_id
	 * @return int
	 */
	public function getCountStudentServiceDiaryOfServiceId($service_id) {

		return $this->createQuery ( 'a' )
			->select ( 'a.id' )
			->addWhere ( 'a.service_id = ?', $service_id )
			->count ();
	}
}