<?php

/**
 * PsEvaluateClassTimeTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsEvaluateClassTimeTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsEvaluateClassTimeTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsEvaluateClassTime' );
	}

	/**
	 * Lay ra Danh sach chi tieu theo Class id
	 *
	 * @param int $class_id
	 * @param date $track_at
	 * @param int $subject_id
	 */
	public function getEvaluateCriteriaByClassId($class_id, $track_at, $schoolyear_id = null, $subject_id = null) {

		$track_at = date ( 'Ymd', strtotime ( $track_at ) );

		$q = $this->createQuery ( 'c' );

		$q->select ( 'c.id AS id, c.myclass_id AS myclass_id, c.date_start AS date_start, c.date_end AS date_end' );

		$q->addSelect ( 'ec.id AS criteria_id, ec.criteria_code AS criteria_code, ec.title AS criteria_title' );

		$q->addSelect ( 'es.id AS evaluate_subject_id' );

		$q->innerJoin ( 'c.PsEvaluateIndexCriteria ec WITH ec.is_activated =?', PreSchool::ACTIVE );

		$q->innerJoin ( 'ec.PsEvaluateSubject es WITH es.is_activated =?', PreSchool::ACTIVE );

		$q->addWhere ( 'c.myclass_id =?', $class_id );

		if ($schoolyear_id > 0) {

			$q->addWhere ( 'es.school_year_id =? OR es.school_year_id IS NULL', $schoolyear_id );
		}

		if ($subject_id > 0) {

			$q->addWhere ( 'ec.evaluate_subject_id =?', $subject_id );
		}
		$q->addWhere ( 'DATE_FORMAT(c.date_start,"%Y%m%d") <= ? AND (c.date_end IS NULL OR  DATE_FORMAT(c.date_end,"%Y%m%d") >= ?)', array (
				$track_at,
				$track_at ) );

		$q->orderBy ( 'ec.iorder ASC, es.iorder ASC' );

		return $q->execute ();
	}

	/**
	 * Lay danh sach linh vuc danh gia theo class id
	 *
	 * @param int $class_id
	 * @param date $track_at
	 */
	public function getEvaluateSubjectByClassId($class_id, $track_at = null, $schoolyear_id = null) {

		$track_at = $track_at ? date ( 'Ymd', strtotime ( $track_at ) ) : date('Ymd');

		$q = $this->createQuery ( 'c' );

		$q->select ( 'c.id AS id, c.myclass_id AS myclass_id, c.date_start AS date_start, c.date_end AS date_end' );

		$q->addSelect ( 'es.id AS subject_id, es.subject_code AS subject_code, es.title AS subject_title' );

		$q->addSelect ( 'ec.id AS criteria_id, ec.criteria_code AS criteria_code, ec.title AS criteria_title' );

		$q->innerJoin ( 'c.PsEvaluateIndexCriteria ec WITH ec.is_activated =?', PreSchool::ACTIVE );

		$q->innerJoin ( 'ec.PsEvaluateSubject es WITH es.is_activated =?', PreSchool::ACTIVE );

		$q->addWhere ( 'c.myclass_id =?', $class_id );

		if ($schoolyear_id > 0) {

			$q->addWhere ( 'es.school_year_id =? OR es.school_year_id IS NULL', $schoolyear_id );
		}

		$q->addWhere ( 'DATE_FORMAT(c.date_start,"%Y%m%d") <= ? AND (c.date_end IS NULL OR  DATE_FORMAT(c.date_end,"%Y%m%d") >= ?)', array (
				$track_at,
				$track_at ) );

		$q->orderBy ( 'ec.iorder ASC, es.iorder ASC' );

		$q->groupBy ( 'ec.evaluate_subject_id' );

		return $q->execute ();
	}
}