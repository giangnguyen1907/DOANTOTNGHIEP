<?php

/**
 * PsConstantOptionTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsConstantOptionTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsConstantOptionTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsConstantOption' );
	}

	/**
	 * FUNCTION: doSelectQuery(Doctrine_Query $query)
	 *
	 * @param
	 *        	Doctrine SQL
	 * @return string SQL
	 */
	public function doSelectQuery(Doctrine_Query $query) {

		$a = $query->getRootAlias ();

		$query->select ( $a . '.id AS id, ' . $a . '.value AS value, ' . $a . '.note AS note, ' . $a . '.updated_at AS updated_at,' . $a . '.ps_customer_id AS ps_customer_id, ' . 'c.title AS title, ' . 'cus.title AS customer_title, ' . 'CONCAT(u.first_name, " ", u.last_name) AS updated_by' );

		$query->innerJoin ( $a . '.PsConstant c' );
		$query->innerJoin ( $a . '.PsCustomer cus' );
		$query->leftJoin ( $a . '.UserUpdated u' );

		/*
		 * if (myUser::isAdministrator ()) {
		 * if (! myUser::credentialPsCustomers('PS_STUDENT_MSTUDENT_FILTER_SCHOOL') && myUser::getPscustomerID() > 0) {
		 * if (myUser::getPscustomerID () > 0)
		 * $query->where ( $a . '.ps_customer_id = ?', myUser::getPscustomerID () );
		 * } else {
		 * $query->where ( $a . '.ps_customer_id = ?', ( int ) myUser::getPscustomerID () );
		 * }
		 */

		if (! myUser::credentialPsCustomers ( 'PS_SYSTEM_CONSTANT_OPTION_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0) {
			$query->where ( $a . '.ps_customer_id = ?', ( int ) myUser::getPscustomerID () );
		}

		return $query;
	}

	/**
	 * getValueByCode($ps_customer_id, $c_code = '')
	 * Lay thong so hang so cua truong
	 *
	 * @param int $ps_customer_id
	 * @param string $c_code
	 * @return $objs
	 */
	public function getConstantByCode($ps_customer_id, $c_code = '') {

		$query = $this->createQuery ( 'a' );

		$query->select ( 'a.id AS id, ' . 'a.value AS value, ' . 'a.ps_customer_id AS ps_customer_id, ' . 'c.c_code AS c_code,' . 'c.value_default AS value_default,' . 'c.title AS title' );

		$query->innerJoin ( 'a.PsConstant c' );

		$query->innerJoin ( 'a.PsCustomer cus' );

		$query->where ( 'a.ps_customer_id = ?', $ps_customer_id );

		if ($c_code != '')
			$query->where ( 'c.c_code = ?', $c_code );

		return $query->fetchOne ();
	}
}