<?php
/**
 * PsSchoolYearTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsSchoolYearTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsSchoolYearTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsSchoolYear' );
	}

	/**
	 * FUNCTION: doSelectQuery(Doctrine_Query $query)
	 *
	 * @param
	 *        	Doctrine SQL
	 * @return string SQL
	 *        
	 */
	public function doSelectQuery(Doctrine_Query $query) {

		$alias = $query->getRootAlias ();
		$query->addSelect ( $alias . '.is_default,' . $alias . '.title,' . $alias . '.note,' . $alias . '.iorder, ' . 'CONCAT( DATE_FORMAT(' . $alias . '.from_date, "%d/%m/%Y")," - ", DATE_FORMAT(' . $alias . '.to_date,"%d/%m/%Y")) AS date,' . $alias . '.updated_at,CONCAT(u.first_name," ",u.last_name) AS updated_by' )
			->leftJoin ( $alias . '.UserUpdated u', true )
			->addOrderBy ( $alias . '.iorder asc' );
		return $query;
	}

	/**
	 * setSqlPsSchoolYears()
	 *
	 * @author Nguyen Chien Thang
	 *        
	 * @return String - SQL
	 */
	public function setSqlPsSchoolYears() {

		$q = $this->createQuery ()
			->select ( 'id, title' )
			->orderBy ( 'is_default DESC,from_date DESC' );

		return $q;
	}

	/**
	 * getPsSchoolYearsDefault()
	 *
	 * @author Pham Van Thien
	 *        
	 * @return $obj
	 */
	public function getPsSchoolYearsDefault() {

		$q = $this->createQuery ()
			->select ( 'id, title, from_date,to_date' )
			->where ( 'is_default = ?', PreSchool::ACTIVE );

		return $q;
	}

	/**
	 * getPsSchoolYears()
	 *
	 * @author Nguyen Chien Thang
	 *        
	 * @return $list obj
	 */
	public function getPsSchoolYears() {

		return $this->setSqlPsSchoolYears ()
			->execute ();
	}

	/**
	 * lấy năm học nhỏ nhất
	 *
	 * @return number min year
	 */
	public function getMinYear() {

		$query = $this->createQuery ()
			->select ( 'YEAR(min(from_date)) as min_year' )
			->fetchOne ();

		return $query->getMinYear ();
	}

	/**
	 * lấy năm học lớn nhất
	 *
	 * @return number max year
	 */
	public function getMaxYear() {

		$query = $this->createQuery ()
			->select ( 'YEAR(max(to_date)) as max_year' )
			->fetchOne ();

		return $query->getMaxYear ();
	}
	
	/**
	 * lấy năm học lớn nhất
	 *
	 * @return number max year
	 */
	public function getYearDataByDate($date_at) {
		
		$date_at = $date_at ? date('Ymd',strtotime($date_at)) : date('Ymd');
		
		$query = $this->createQuery ('a')
		->select ( 'a.id as id' )
		->where('DATE_FORMAT(a.from_date,"%Y%m%d") <= ? AND DATE_FORMAT(a.to_date,"%Y%m%d") >= ?', array($date_at,$date_at));
		
		return $query->fetchOne ();
	}
	
	public function getPsSchoolYearByField($id,$getField = null) {
		
		$query = $this->createQuery () ->select ( $getField != '' ? $getField : '*' );
		
		$query->addWhere ( 'id = ?', $id );
		
		return $query->fetchOne ();
	}
}