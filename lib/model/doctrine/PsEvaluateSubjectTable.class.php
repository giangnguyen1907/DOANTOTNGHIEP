<?php

/**
 * PsEvaluateSubjectTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsEvaluateSubjectTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsEvaluateSubjectTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsEvaluateSubject' );
	}

	/**
	 * Set SQL lay danh sach PsEvaluateIndexSubject
	 *
	 * @return : list Obj
	 */
	public function setSQLEvaluateIndexSubjectByParam($param) {

		// print_r($param);die;
		$q = $this->createQuery ( 's' )
			->select ( 's.id AS id, CONCAT(s.subject_code, ": ",s.title) AS title, s.subject_code AS subject_code' );

		if (isset ( $param ['is_activated'] ) && $param ['is_activated'] >= 0) {
			$q->addWhere ( 's.is_activated = ?', $param ['is_activated'] );
		}
		if (isset ( $param ['ps_customer_id'] ) && $param ['ps_customer_id'] > 0) {
			$q->addWhere ( 's.ps_customer_id = ?', $param ['ps_customer_id'] );
		}
		if (isset ( $param ['ps_workplace_id'] ) && $param ['ps_workplace_id'] > 0) {
			$q->addWhere ( '(s.ps_workplace_id IS NULL OR s.ps_workplace_id = ?)', $param ['ps_workplace_id'] );
		}
		if (isset ( $param ['school_year_id'] ) && $param ['school_year_id'] > 0) {
			$q->addWhere ( '(s.school_year_id IS NULL OR s.school_year_id = ?)', $param ['school_year_id'] );
		}
		if (isset ( $param ['subject_id'] ) && $param ['subject_id'] > 0) {
			$q->addWhere ( 's.id = ?', $param ['subject_id'] );
		}
		$q->addOrderBy ( 's.iorder' );

		return $q;
	}

	public function doSelectQuery(Doctrine_Query $query) {

		$alias = $query->getRootAlias ();
		$query->addSelect ( $alias . '.id as id,' . $alias . '.title as title,' . $alias . '.subject_code as subject_code, ' . $alias . '.is_activated as is_activated, ' . $alias . '.iorder as iorder, ' );
		// 'CONCAT( DATE_FORMAT('.$alias.'.from_date, "%d/%m/%Y")," - ", DATE_FORMAT('.$alias.'.to_date,"%d/%m/%Y")) AS date,'.
		$query->addSelect ( 'CONCAT(u.first_name," ",u.last_name) AS updated_by' );

		$query->addSelect ( 'wp.id as ps_workplace_id, wp.title as wp_title' );

		$query->addSelect ( 'cus.id AS ps_customer_id, cus.title AS school_name, cus.school_code AS school_code' );

		$query->addSelect ( 'sy.id as school_year_id, sy.title as sy_title' );

		$query->leftJoin ( $alias . '.PsCustomer cus' );

		$query->leftJoin ( $alias . '.PsWorkPlaces wp' );

		$query->leftJoin ( $alias . '.PsSchoolYear sy' );

		$query->leftJoin ( $alias . '.UserUpdated u' );

		$query->addOrderBy ( $alias . '.iorder asc' );

		if (! myUser::credentialPsCustomers ( 'PS_EVALUATE_INDEX_SUBJECT_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0) {
			$query->addWhere ( $a . '.ps_customer_id = ?', myUser::getPscustomerID () );
		}

		return $query;
	}

	/**
	 * Lay ra danh sach chu de theo truong va co so
	 *
	 * @param int $customer_id
	 * @param int $workplace_id
	 * @param int $schoolyear_id
	 */
	public function getSubjectByCustomerWorkplaceId($customer_id, $workplace_id = null, $schoolyear_id = null) {

		$q = $this->createQuery ( 's' );

		$q->select ( 's.id AS id, s.subject_code AS subject_code, s.title AS title' );

		$q->andWhere ( 's.is_activated = ?', PreSchool::ACTIVE );

		$q->andWhere ( 's.ps_customer_id = ?', $customer_id );

		if ($workplace_id > 0) {

			$q->andWhere ( 's.ps_workplace_id IS NULL OR s.ps_workplace_id = ?', $workplace_id );
		}

		if ($schoolyear_id > 0) {

			$q->andWhere ( 's.school_year_id IS NULL OR s.school_year_id = ?', $schoolyear_id );
		}

		$q->addOrderBy ( 'iorder ASC' );

		return $q->execute ();
	}

	/**
	 *	 
	 **/
	public function getSubjectByCustomerWorkplaceClassId($customer_id, $workplace_id = null, $schoolyear_id = null, $class_id) {
		
		$q = $this->createQuery ( 's' );
		
		$q->select ( 's.id AS id, s.subject_code AS subject_code, s.title AS title, c.id AS criteria_id, ect.id AS class_time_id' );
		
		$q->innerJoin( 's.PsEvaluateIndexCriteria c WITH c.is_activated =?', PreSchool::ACTIVE );
		
		$q->innerJoin('c.PsEvaluateClassTime ect WITH ect.myclass_id =?',$class_id);
		
		$q->andWhere ( 's.is_activated = ?', PreSchool::ACTIVE );
		
		$q->andWhere ( 's.ps_customer_id = ?', $customer_id );
		
		if ($workplace_id > 0) {
			
			$q->andWhere ( 's.ps_workplace_id IS NULL OR s.ps_workplace_id = ?', $workplace_id );
		}
		
		if ($schoolyear_id > 0) {
			
			$q->andWhere ( 's.school_year_id IS NULL OR s.school_year_id = ?', $schoolyear_id );
		}
		
		$q->addOrderBy ( 'iorder ASC' );
		
		return $q->execute ();
	}
	
	/**
	 * Lay ra chi so danh gia va chu de danh gia
	 *
	 * @param int $criteria_id
	 */
	public function getSubjectById($criteria_id) {

		$q = $this->createQuery ( 's' );

		// $q->andWhere('c.is_activated=?', PreSchool::ACTIVE);

		$q->select ( 'c.id AS id, c.criteria_code AS criteria_code, c.title AS criteria_title' );

		$q->addSelect ( 's.id AS subject_id, s.subject_code AS subject_code, s.title AS subject_title, s.ps_customer_id AS ps_customer_id, s.ps_workplace_id AS ps_workplace_id, s.school_year_id AS school_year_id' );

		// $q->andWhere('s.is_activated=?', PreSchool::ACTIVE);

		$q->leftJoin ( 's.PsEvaluateIndexCriteria c ' );

		$q->andWhere ( 'c.id =? ', $criteria_id );

		$q->groupBy ( 's.id, c.id' );

		$q->addOrderBy ( 's.iorder asc, c.iorder asc' );

		return $q->fetchOne ();
	}
}