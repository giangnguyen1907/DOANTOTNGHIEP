<?php

/**
 * PsAdviceFeedbacksTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsAdviceFeedbacksTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsAdviceFeedbacksTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsAdviceFeedbacks' );
	}

	/**
	 * Lay thong tin bang PsAdvice
	 */
	public function getAdviceFeedback($advice_id) {

		$query = $this->createQuery ( 'af' );

		$query->select ( 'a.id AS id,' . 'a.student_id AS student_id,' . 'a.user_id AS user_id,' . 'a.category_id AS category_id,' . 'a.title AS title,' . 'a.content AS content,' . 'a.is_activated AS is_activated,' . 'ac.title AS ac_title,' . 'a.user_created_id AS user_created_id,' . 'a.created_at AS created_at,' . 'a.updated_at AS updated_at,' . 'a.date_at AS date_at,' . 's.student_code AS student_code,' . 'CONCAT(s.first_name, " ", s.last_name) AS student_name,' . 'CONCAT(uc.first_name, " ", uc.last_name) AS creator_by,' . 'af.content AS feedback_content' );

		$query->innerJoin ( 'af.PsAdvices a' );

		$query->innerJoin ( 'a.PsStudent s' );

		$query->leftJoin ( 'a.PsAdviceCategories ac' );

		$query->leftJoin ( 'a.UserCreated uc' );

		if (! myUser::credentialPsCustomers ( 'PS_STUDENT_RELATIVE_ADVICE_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0) {

			$query->addWhere ( 'a.ps_customer_id = ?', myUser::getPscustomerID () );

			$query->addWhere ( 'a.is_activated = ?', PreSchool::ACTIVE );
		}

		$query->leftJoin ( 'a.UserId ui' );

		$query->addWhere ( 'af.advice_id =?', $advice_id );

		$query->orderBy ( 'a.created_at DESC' );

		return $query->fetchOne ();
	}
}