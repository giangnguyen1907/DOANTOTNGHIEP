<?php

/**
 * PsFoodsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsFoodsTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsFoodsTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsFoods' );
	}

	/**
	 * FUNCTION: doSelectQuery(Doctrine_Query $query)
	 *
	 * @param
	 *        	Doctrine SQL
	 * @return string SQL
	 *        
	 */
	public function doSelectQuery(Doctrine_Query $query) {

		$a = $query->getRootAlias ();

		$query->select ( $a . '.id AS id, ' . $a . '.title AS title, '. $a . '.file_image AS file_image, ' . $a . '.note AS note, ' . $a . '.iorder AS iorder, ' . $a . '.ps_image_id AS ps_image_id, I.file_name AS file_name, ' . $a . '.ps_customer_id AS ps_customer_id, ' . 'cus.title AS customer_title, ' . $a . '.is_activated AS is_activated, ' . $a . '.user_updated_id AS user_updated_id, ' . $a . '.updated_at AS updated_at,' . 'CONCAT(u.first_name, " ", u.last_name) AS updated_by' );

		$query->leftJoin ( $a . '.PsImages I' );
		$query->leftJoin ( $a . '.PsCustomer cus' );
		$query->leftJoin ( $a . '.UserUpdated u' );
		$query->leftJoin ( 'cus.PsWard pw' );
		$query->leftJoin ( 'pw.PsDistrict d' );
		$query->leftJoin ( 'd.PsProvince p' );

		if (! myUser::credentialPsCustomers ( 'PS_NUTRITION_FOOD_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0)
			$query->addWhere ( $a . '.ps_customer_id IS NULL or ' . $a . '.ps_customer_id = ?', myUser::getPscustomerID () );
		else {
			$query->addWhere ( ' 1=1' );
		}

		return $query;
	}

	public function setSQLByCustomerId($getField = 'a.id AS id, a.title AS title', $psCustomerId = null, $is_activated = null) {

		$q = $this->createQuery ( 'a' )
			->select ( 'a.id AS id, a.title AS title,a.file_image AS file_image, I.file_name AS file_name' )
			->leftJoin ( 'a.PsImages I' );

		if ($is_activated > 0)
			$q->addWhere ( 'a.is_activated = ?', $is_activated );

		if ($psCustomerId > 0)
			$q->addWhere ( 'a.ps_customer_id IS NULL OR a.ps_customer_id = ?', $psCustomerId );
		else
			$q->where ( 'a.ps_customer_id IS NULL' );

		$q->addOrderBy ( 'a.title, a.iorder' );

		return $q;
	}

	/**
	 * FUNCTION: setChoisPsFoods($country_code)
	 *
	 * @param $file_group -
	 *        	string
	 * @return $list obj
	 */
	public function setChoisPsFoods($getField = 'a.id, a.title', $psCustomerId = null, $is_activated = null) {

		$ps_objs = $this->setSQLByCustomerId ( $getField, $psCustomerId, $is_activated )
			->execute ();

		$chois = array ();

		foreach ( $ps_objs as $ps_obj ) {
			
			if($ps_obj->getFileImage () !=''){
				$path_file = '/uploads/ps_nutrition/thumb/' . $ps_obj->getFileImage ();
			}else{
				$path_file = '/sys_icon/' . $ps_obj->getFileName ();
			}
			
			$chois [$ps_obj->getId ()] = array (
					'title' => $ps_obj->getTitle (),
					'imagesrc' => sfContext::getInstance ()->getRequest () ->getRelativeUrlRoot () . $path_file );
		}

		return $chois;
	}
}