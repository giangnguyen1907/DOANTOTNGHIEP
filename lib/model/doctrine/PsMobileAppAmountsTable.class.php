<?php

/**
 * PsMobileAppAmountsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsMobileAppAmountsTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsMobileAppAmountsTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsMobileAppAmounts' );
	}

	/**
	 * FUNCTION: doSelectQuery(Doctrine_Query $query)
	 *
	 * @param
	 *        	Doctrine SQL
	 * @return string SQL
	 *        
	 */
	public function doSelectQuery(Doctrine_Query $query) {

		// $date_at = date('Ymd');

		// $a = $query->getRootAlias();

		// $query->select(
		// $a.'.amount AS amount,'.
		// $a.'.expiration_date_at AS expiration_date,'.
		// $a.'.description AS description,'
		// .'CONCAT(u.first_name, " ", u.last_name) AS user_name'
		// );

		// $query->leftJoin($a.'.UserMobileAppAmounts u');

		// $date_at = date('Ymd');

		// $query->leftJoin('u.Relative rl on rl.id = u.member_id');

		// $query->leftJoin('rl.RelativeStudent rs');

		// $query->leftJoin('rs.Student s');

		// $query->leftJoin('s.StudentClass scl With (DATE_FORMAT(scl.start_at,"%Y%m%d") <= ? AND (scl.stop_at IS NULL OR DATE_FORMAT(scl.stop_at,"%Y%m%d") >= ?))', array($date_at, $date_at) );

		// $query->leftJoin('scl.MyClass mc');

		// $query->leftJoin('mc.PsClassRooms cr');

		// $query->leftJoin('cr.PsWorkPlaces wp');

		// // PS_MOBILE_APP_AMOUNTS_FILTER_SCHOOL
		// // PS_CMS_ARTICLES_ADD
		// if (!myUser::credentialPsCustomers('PS_CMS_ARTICLES_ADD') && myUser :: getPscustomerID()) {

		// $query->addWhere('u.ps_customer_id = ? ', myUser :: getPscustomerID());
		// }

		// $query->addWhere('u.user_type = ?', PreSchool::USER_TYPE_RELATIVE);

		// // $query->addWhere('DATE_FORMAT('.$a.'.expiration_date_at,"%Y%m%d") >= ?', date("Ymd", strtotime($date_at)));

		// return $query;
		$date_at = date ( 'Ymd' );

		$query = Doctrine_Query::create ()->from ( 'sfGuardUser u' );

		$query->select ( 'ama.id AS amount_id,' . 'u.id AS user_id,' . 'hs.id AS history_id,' . 'ama.amount AS amount,' . 'ama.expiration_date_at AS expiration_date_at,' . 'ama.description AS description,' . "CONCAT(u.first_name, ' ', u.last_name, ' (' ,u.username, ')' ) AS relative_user_name" );

		$query->leftJoin ( 'u.PsMobileAppAmounts ama' );

		$query->leftJoin ( 'u.PsHistoryMobileAppPayAmounts hs' );

		$query->leftJoin ( 'u.PsRelative rl' );

		$query->leftJoin ( 'rl.RelativeStudent rs' );

		$query->leftJoin ( 'rs.Student st' );

		$query->leftJoin ( 'st.StudentClass scl With (DATE_FORMAT(scl.start_at,"%Y%m%d") <= ? AND (scl.stop_at IS NULL OR  DATE_FORMAT(scl.stop_at,"%Y%m%d") >= ?))', array (
				$date_at,
				$date_at ) );

		$query->leftJoin ( 'scl.MyClass mc' );

		$query->leftJoin ( 'mc.PsClassRooms cr' );

		$query->leftJoin ( 'cr.PsWorkPlaces wp' );

		if (! myUser::credentialPsCustomers ( 'PS_CMS_ARTICLES_ADD' ) && myUser::getPscustomerID () > 0) {

			$query->addWhere ( 'u.ps_customer_id = ? ', myUser::getPscustomerID () );
		}

		$query->addWhere ( 'u.user_type = ?', PreSchool::USER_TYPE_RELATIVE );
		$query->addOrderBy ( 'hs.created_at desc' );
		// $query->addWhere('DATE_FORMAT(ama.expiration_date_at,"%Y%m%d") > ?', date("Ymd", strtotime($date_at)));

		return $query;
	}
}