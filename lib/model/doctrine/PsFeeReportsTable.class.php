<?php

/**
 * PsFeeReportsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsFeeReportsTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsFeeReportsTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsFeeReports' );
	}

	public function doSelectQuery(Doctrine_Query $query) {

		$query = Doctrine_Query::create ()->
		from ( 'Student s' );

		$query->select ( 's.ps_customer_id AS ps_customer_id,' . 's.image AS image, ' . 's.id as student_id, s.student_code AS student_code, ' . 's.sex AS sex, ' . 's.birthday AS birthday, ' . 's.year_data AS year_data, ' . 'cus.school_code AS school_code,' . 'CONCAT(s.first_name, " ", s.last_name) AS student_name' );

		// $query->leftJoin('s.PsFeeReports fr');

		// $query->innerJoin('s.StudentClass sc');

		$query->innerJoin ( 's.PsCustomer cus' );

		$query->addWhere ( 's.deleted_at IS NULL' );

		if (! myUser::credentialPsCustomers ( 'PS_FEE_REPORT_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0) {
			$query->addWhere ( 's.ps_customer_id = ?', myUser::getPscustomerID () );
		}

		$query->orderBy ( 's.last_name, s.first_name' );

		return $query;
	}

	/**
	 * Lay phieu bao cua hoc sinh
	 *
	 * @param
	 *        	int - $student_id, ma hoc sinh
	 * @param $date -
	 *        	inttime, thoi gian
	 * @return $obj
	 *
	 */
	public function findPsFeeReportOfStudentByDate($student_id, $date) {

		$q = $this->createQuery ( 'r' )
			->select ( 'r.*' )
			->where ( "r.student_id = ? AND DATE_FORMAT(r.receivable_at,'%Y%m') = ? ", array (
				$student_id,
				date ( 'Ym', $date ) ) )
			->limit ( 1 );

		return $q->fetchOne ();
	}

	/**
	 * Lay ma phieu bao cua hoc sinh
	 *
	 * @param
	 *        	int - $student_id, ma hoc sinh
	 * @param $date -
	 *        	inttime, thoi gian
	 * @return $obj
	 *
	 */
	public function findPsFeeReportOfStudentByDate2($student_id, $date) {

		$q = $this->createQuery ( 'r' )
			->select ( 'r.id, r.ps_fee_report_no' )
			->where ( "r.student_id = ? AND DATE_FORMAT(r.receivable_at,'%Y%m') = ? ", array (
				$student_id,
				date ( 'Ym', $date ) ) )
			->limit ( 1 );

		return $q->fetchOne ();
	}

	/**
	 * Lay phieu bao gan $intdate nhat cua mot hoc sinh
	 *
	 * @param
	 *        	int - $student_id, ma hoc sinh
	 * @param $intdate -
	 *        	inttime, thoi gian
	 * @return $obj
	 */
	public function getMaxFeeReportPrevOfStudent($student_id, $intdate) {

		$q = $this->createQuery ( 'r' )
			->select ( 'r.*' )
			->where ( "r.student_id = ? AND DATE_FORMAT(r.receivable_at,'%Y%m') < ? ", array (
				$student_id,
				date ( 'Ym', $intdate ) ) )
			->orderBy ( "r.receivable_at DESC" )
			->limit ( 1 );

		return $q->fetchOne ();
	}

	/**
	 * Kiem tra phieu thu ton tai hay khong
	 *
	 * @author Phung Van Thanh
	 * @param
	 *        	int student_id, tracked_at
	 * @return Obj
	 *
	 *
	 */
	public function checkFeeReportsOfMonth($student_id, $receipt_date) {

		$q = $this->createQuery ( 'c' )
			->select ( "c.id, c.student_id, c.receivable_at, CONCAT(s.first_name, ' ', s.last_name) AS student_name" );

		$q->leftJoin ( 'c.Student s' );

		$q->where ( 'c.student_id = ?', $student_id );

		$q->andWhere ( 'DATE_FORMAT(c.receivable_at,"%Y%m") >= ?', date ( "Ym", strtotime ( $receipt_date ) ) );

		return $q->fetchOne ();
	}

	/**
	 * Lay phieu bao cua hoc sinh trong thang
	 *
	 * @author ThanhPV
	 *        
	 * @return $obj
	 *
	 */
	public function getAmountFeeReceiptOfMonth($student_code, $date_at) {

		$query = $this->createQuery ()
			->from ( 'Student s' );

		$query->select ( 's.id as student_id, fr.receivable AS receivable,fr.id AS fr_id' );

		$query->innerJoin ( 's.PsFeeReports fr With DATE_FORMAT(fr.receivable_at,"%Y%m") = ?', date ( 'Ym', strtotime ( $date_at ) ) );

		$query->andWhere ( 's.student_code =?', $student_code );

		return $query->fetchOne ();
	}
}