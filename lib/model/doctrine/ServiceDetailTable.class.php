<?php

/**
 * ServiceDetailTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ServiceDetailTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object ServiceDetailTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'ServiceDetail' );
	}

	/**
	 * Lay thong tin chi tiet cua mot dich vu xac dinh boi date
	 *
	 * @author NguyenChienThang
	 * @version 2.0
	 */
	public function findOneServiceDetailByDate($service_id, $datetime) {

		$date = date ( 'Ym', $datetime );

		$q = $this->createQuery ( 'c' )
			->select ( 'c.id as id,c.amount as amount,c.service_id as service_id,c.by_number AS by_number,c.detail_at as detail_at, s.is_type_fee AS is_type_fee' )
			->innerJoin ( 'c.Service s' )
			->where ( 'c.service_id = ?', $service_id )
			->andWhere ( "DATE_FORMAT(c.detail_at,'%Y%m') <= ? AND (c.detail_end IS NULL OR DATE_FORMAT(c.detail_end,'%Y%m') >= ?)", array (
				$date,
				$date ) )
			->orderBy ( 'c.detail_at DESC' )
			->limit ( 1 );

		return $q->fetchOne ();
	}

	// =================== END: NEW VESION =============================================>

	/**
	 *
	 * @param integer $service_id
	 * @param timestamp $date
	 */
	public function getServiceDetailByDate($service_id, $date) {

		$q = $this->createQuery ( 'c' )
			->andWhere ( "DATE_FORMAT(c.detail_at,'%Y%m%d') <= ?", date ( 'Ymd', $date ) )
			->andWhere ( 'c.service_id = ?', $service_id )
			->orderBy ( 'c.detail_at DESC' )
			->limit ( 1 );
		return $q->fetchOne ();
	}

	/**
	 *
	 * @param integer $service_id
	 * @param timestamp $date
	 */
	public function findByDate($service_id, $date) {

		$q = $this->createQuery ( 'c' )
			->andWhere ( "DATE_FORMAT(c.detail_at,'%Y%m') <= ?", date ( 'Ym', $date ) )
			->andWhere ( 'c.service_id = ?', $service_id )
			->orderBy ( 'c.detail_at DESC' )
			->limit ( 1 );
		return $q->fetchOne ();
	}

	public function getDetailForReportCard($service_id, $date) {

		$q = $this->createQuery ( 'c' )
			->Where ( "DATE_FORMAT(c.detail_at,'%Y%m') <= ?", date ( 'Ym', $date ) )
			->andWhere ( "DATE_FORMAT(c.detail_end,'%Y%m') >= ?", date ( 'Ym', $date ) )
			->andWhere ( 'c.service_id = ?', $service_id )
			->limit ( 1 );
		return $q->fetchOne ();
	}

	public function getServiceDetailById($service_id) {

		$query = $this->createQuery ( 'd' );

		$query->select ( 'd.id AS id,' . 'd.amount AS amount,' . 'd.detail_at AS detail_at,' . 'd.detail_end AS detail_end,' . 'd.by_number AS by_number,' . 'd.created_at AS created_at,' . 'd.updated_at AS updated_at' );

		$query->addWhere ( 'd.service_id = ?', $service_id );

		return $query->execute ();
	}

	public function getLatestAmountById($service_id) {

		$query = $this->createQuery ( 'a' );
		$query->select ( 'a.amount AS amount' );

		$query->addOrderBy ( 'a.detail_at DESC' );
		$query->addWhere ( 'a.service_id = ?', $service_id );
		return $query->fetchOne ();
	}
}