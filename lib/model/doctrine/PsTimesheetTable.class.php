<?php

/**
 * PsTimesheetTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsTimesheetTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsTimesheetTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsTimesheet' );
	}

	public function doSelectQuery(Doctrine_Query $query) {

		$date_at = date ( 'Y-m-d' );
		// echo $date_at; die();
		$query = Doctrine_Query::create ()->
		from ( 'PsMember mb' );
		$query->select ( 'mb.id AS id, mb.id AS member_id,' . 'mb.sex AS sex, ' . 'mb.birthday AS birthday, ' . 'mb.ps_customer_id AS ps_customer_id, ' . 'dpm.id AS dpm_id, ' . 'ts.id AS ts_id, ' . 'ts.member_id AS ts_member_id, ' . 'ts.time_at AS time_at, ' . 'ts.is_io AS is_io, ' . 'ts.number_time AS number_time, ' . 'ts.timesheet_at AS timesheet_at, ' . 'ts.description AS description, ' . 'ts.updated_at AS updated_at, ' . 'cus.school_code AS school_code,' . 'CONCAT(mb.first_name, " ", mb.last_name) AS member_name,' );

		$query->leftJoin ( 'mb.PsTimesheet ts' );

		$query->innerJoin ( 'mb.PsCustomer cus' );

		$query->leftJoin ( 'mb.PsMemberDepartments dpm' );

		$query->leftJoin ( 'dpm.PsDepartment dp' );

		if (! myUser::credentialPsCustomers ( 'PS_HR_TIMESHEET_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0) {
			$query->where ( 'mb.ps_customer_id =?', myUser::getPscustomerID () );
		}

		$query->where ( 'mb.is_status =?', 'W' );

		$query->orderBy ( 'mb.last_name,ts.id desc' );

		return $query;
	}

	public function getMemberTimesheet($member_id) {

		$q = $this->createQuery ()
			->select ( 'id,time_at,member_id' )
			->orderBy ( 'id DESC' )
			->limit ( 1 )
			->addWhere ( 'member_id =?', $member_id );
		return $q->fetchOne ();
	}

	public function getTimesheetByMember($member_id) {

		$q = $this->createQuery ()
			->select ( 'id,time_at,member_id' )
			->orderBy ( 'time_at DESC' )
			->limit ( 1 )
			->addWhere ( 'member_id =?', $member_id )
			->andWhere ( 'is_io = 1' );
		return $q->fetchOne ();
	}

	/**
	 * Xem lai thoi gian vao ra cua nhan vien theo ngay
	 */
	public function getListTimesheet($ps_customer_id, $ps_workplace_id, $ps_department_id, $member_id, $date_at) {

		$date_at = ($date_at != '') ? $date_at : date ( 'Ymd' );

		$query = $this->createQuery ( 'ts' );

		$query->select ( 'ts.id AS ts_id, ' . 'ts.member_id AS member_id, ' . 'ts.time_at AS time_at, ' . 'ts.is_io AS is_io, ' . 'ts.number_time AS number_time, ' . 'ts.timesheet_at AS timesheet_at, ' . 'ts.description AS description, ' . 'ts.updated_at AS updated_at, ' . 'mb.id AS mb_id, ' . 'cus.school_code AS school_code,' . 'CONCAT(mb.first_name, " ", mb.last_name) AS member_name,' );

		$query->addSelect ( 'CONCAT(u.first_name, " ", u.last_name) AS updated_by' );

		$query->leftJoin ( 'ts.PsMember mb' );

		$query->innerJoin ( 'mb.PsCustomer cus' );

		$query->leftJoin ( 'mb.PsMemberDepartments dpm' );

		$query->leftJoin ( 'dpm.PsDepartment dp' );

		$query->innerJoin ( 'ts.UserUpdated u' );

		$query->addWhere ( 'dp.ps_customer_id =?', $ps_customer_id );

		$query->andWhere ( 'dp.ps_workplace_id =?', $ps_workplace_id );

		$query->andWhere ( 'dpm.ps_department_id =?', $ps_department_id );

		if ($member_id > 0)
			$query->andWhere ( 'mb.id =?', $member_id );

		$query->andWhere ( ' DATE_FORMAT(ts.time_at,"%Y%m%d") = ?', date ( 'Ymd', strtotime ( $date_at ) ) );

		$query->andWhere ( ' DATE_FORMAT(dpm.start_at,"%Y%m%d") <= ?', date ( 'Ymd', strtotime ( $date_at ) ) );

		$query->andWhere ( 'dpm.stop_at IS NULL OR DATE_FORMAT(dpm.stop_at,"%Y%m%d") >= ?', date ( 'Ymd', strtotime ( $date_at ) ) );

		$query->orderBy ( 'mb.last_name desc, ts.time_at desc' );

		return $query->execute ();
	}

	/**
	 * lay ra tong thoi gian trong ngay cua nhan vien
	 */
	public function getSumTimesheetOfMember($ps_customer_id, $ps_workplace_id, $ps_department_id, $year_month) {

		$date_at = '01-' . $year_month;
		$date_next = '31-' . $year_month;

		$query = $this->createQuery ( 'ts' );

		$query->select ( 'SUM(number_time) AS number_time,' . 'ts.id AS ts_id, ' . 'ts.member_id AS member_id, ' . 'ts.time_at AS time_at, ' . 'ts.is_io AS is_io, ' . 'ts.timesheet_at AS timesheet_at, ' . 'ts.description AS description, ' . 'ts.updated_at AS updated_at, ' . 'mb.id AS mb_id, ' . 'dpm.id AS dpm_id,' . 'dp.id AS dp_id,' . 'cus.school_code AS school_code,' . 'CONCAT(mb.first_name, " ", mb.last_name) AS member_name,' );

		$query->addSelect ( 'CONCAT(u.first_name, " ", u.last_name) AS updated_by' );

		$query->leftJoin ( 'ts.PsMember mb' );

		$query->innerJoin ( 'mb.PsCustomer cus' );

		$query->leftJoin ( 'mb.PsMemberDepartments dpm' );

		$query->leftJoin ( 'dpm.PsDepartment dp' );

		$query->innerJoin ( 'ts.UserUpdated u' );

		if ($ps_department_id > 0)
			$query->andWhere ( 'dpm.ps_department_id =?', $ps_department_id );
		elseif ($ps_workplace_id > 0)
			$query->andWhere ( 'dp.ps_workplace_id =?', $ps_workplace_id );
		else
			$query->addWhere ( 'dp.ps_customer_id =?', $ps_customer_id );

		$query->andWhere ( ' DATE_FORMAT(ts.timesheet_at,"%Y%m%d") >= ?', date ( 'Ymd', strtotime ( $date_at ) ) );

		$query->andWhere ( ' DATE_FORMAT(ts.timesheet_at,"%Y%m%d") <= ?', date ( 'Ymd', strtotime ( $date_next ) ) );

		$query->andWhere ( 'ts.is_io = 0' );

		$query->groupBy ( 'ts.member_id, dp.id, DATE_FORMAT(ts.timesheet_at, "%Y%m%d")' );

		$query->orderBy ( 'mb.last_name desc, ts.timesheet_at desc' );

		return $query->execute ();
	}
}
