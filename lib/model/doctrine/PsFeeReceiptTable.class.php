<?php

/**
 * PsFeeReceiptTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PsFeeReceiptTable extends Doctrine_Table {

	/**
	 * Returns an instance of this class.
	 *
	 * @return object PsFeeReceiptTable
	 */
	public static function getInstance() {

		return Doctrine_Core::getTable ( 'PsFeeReceipt' );
	}

	public function doSelectQuery(Doctrine_Query $query) {

		$a = $query->getRootAlias ();

		$query->select ( $a . '.id AS id,' . $a . '.receipt_no AS receipt_no,' . $a . '.receivable_amount AS receivable_amount,' . $a . '.collected_amount AS collected_amount,' . $a . '.balance_amount AS balance_amount,' . $a . '.receipt_date AS receipt_date,' . $a . '.note AS 	note,' . 'CONCAT(u.first_name, " ", u.last_name) AS updated_by,' . $a . '.updated_at AS updated_at, ' );

		$query->addSelect ( 's.id AS student_id, s.image AS image, s.student_code AS student_code, CONCAT(s.first_name, " ", s.last_name) AS student_name,sc.id as sc_id' );

		$query->leftJoin ( $a . '.Student s' );

		$query->leftJoin ( $a . '.UserUpdated u' );

		$query->leftJoin ( 's.StudentClass sc With (DATE_FORMAT(sc.start_at,"%Y%m%d") <= ? AND (sc.stop_at IS NULL OR DATE_FORMAT(sc.stop_at,"%Y%m%d") >= ?))', array (
				date ( 'Ymd' ),
				date ( 'Ymd' ) ) );

		$query->whereIn ( 'sc.type', array (
				PreSchool::SC_STATUS_OFFICIAL,
				PreSchool::SC_STATUS_TEST ) );

		if (! myUser::credentialPsCustomers ( 'PS_FEE_REPORT_FILTER_SCHOOL' ) && myUser::getPscustomerID () > 0) {
			$query->where ( $a . '.ps_customer_id = ?', myUser::getPscustomerID () );
		}

		return $query;
	}

	public function getPsFeeReceiptByField($student_id,$getField = null) {
		
		$query = $this->createQuery () ->select ( $getField != '' ? $getField : '*' );
		
		$query->addWhere ( 'id = ?', $student_id );
		
		return $query->fetchOne ();
	}
	
	
	/**
	 * Kiểm tra xem đã có dữ liệu chưa
	 */
	public function getCheckStudentAndDate($student_id, $receivable_date) {

		$query = $this->createQuery ( 'a' );

		$query->select ( 'a.id, a.student_id' );

		$query->addWhere ( 'a.student_id = ?', $student_id );
		$query->andWhere ( 'DATE_FORMAT(a.receipt_date,"%Y%m") = ?', date ( 'Ym', strtotime ( $receivable_date ) ) );

		return $query->fetchOne ();
	}
}